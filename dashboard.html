<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GbSoft - Dashboard</title>
    <link rel="stylesheet" href="style_dash.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBSKZO6JqTPQIaVsuMRF_NifGvuiLT2STc",
            authDomain: "controle-usuario-64b08.firebaseapp.com",
            projectId: "controle-usuario-64b08",
            storageBucket: "controle-usuario-64b08.firebasestorage.app",
            messagingSenderId: "1005734164997",
            appId: "1:1005734164997:web:0cfa0b869178aa4b947a6c"
        };


        firebase.initializeApp(firebaseConfig);// Inicialização do Firebase


        const db = firebase.firestore();// Obter referência do Firestore


        document.addEventListener('DOMContentLoaded', function () {        // Verificar autenticação na página do Dashboard
            firebase.auth().onAuthStateChanged(function (user) {
                if (!user) {

                    window.location.href = 'index.html';// Se não estiver autenticado, redirecionar para o login
                }
            });
        });
    </script>
    <style>
        .empresas-grid-container {
            overflow-x: auto;
            /* Permite rolar para os lados */
            overflow-y: auto;
            /* Permite rolar para baixo */
            max-height: 500px;
            /* Define uma altura máxima */
            background-color: #e8e8e8;
            /* Cor de fundo levemente alterada para visualização */
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #ccc;
            width: 100%;
            /* Garante que a largura se ajuste ao conteúdo */
            min-height: 300px;
            /* Define uma altura mínima para melhor visualização */
        }
    </style>

</head>

<body>
    <div class="container">
        <nav class="sidebar"> <!-- Menu Lateral com efeito dropdown -->
            <div class="menu-header">GB SISTEMAS</div>
            <ul class="menu-categories">
                <li class="menu-category">
                    <div class="category-header">
                        <i class="fas fa-chart-bar"></i>
                        <span>Prefeitura</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-pen"></i>NFS-e mensal</a></li>
                        <li><a href="#"><i class="fas fa-dollar-sign"></i>NFS-e Anual</a></li>
                        <li><a href="#"><i class="fas fa-history"></i>DARF</a></li>
                    </ul>
                </li>
                <li class="menu-category">
                    <div class="category-header">
                        <i class="fas fa-file-invoice"></i>
                        <span>Sefaz</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-file-alt"></i>Notas Fiscais 55</a></li>
                        <li><a href="#"><i class="fas fa-receipt"></i>NFC-e</a></li>
                        <li><a href="#"><i class="fas fa-truck"></i>Cte Emissor</a></li>
                    </ul>
                </li>
                <li class="menu-category">
                    <div class="category-header">
                        <i class="fas fa-certificate"></i>
                        <span>Certidões</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-building"></i>Ecac PJ</a></li>
                        <li><a href="#"><i class="fas fa-user"></i>Ecac PF</a></li>
                        <li><a href="#"><i class="fas fa-city"></i>Municipal</a></li>
                        <li><a href="#"><i class="fas fa-landmark"></i>Sefaz</a></li>
                        <li><a href="#"><i class="fas fa-id-card"></i>Regularidade FGTS</a></li>
                    </ul>
                </li>
                <li class="menu-category">
                    <div class="category-header">
                        <i class="fas fa-cog"></i>
                        <span>Empresas</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-question-circle"></i> Geral</a></li>
                    </ul>
                </li>
                <li class="menu-category">
                    <div class="category-header">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <ul class="submenu">
                        <li><a href="#" id="btnCadastrar"><i class="fas fa-question-circle"></i> Cadastrar</a></li>
                    </ul>
                    <ul class="submenu">
                        <li><a href="#" id="btnBuscar"><i class="fas fa-question-circle"></i> Buscar</a></li>
                    </ul>
                </li>
                <li class="menu-logout">
                    <a href="#" id="btnLogout"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <header>
                <h1>G B SISTEMAS</h1>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Filtrar" class="search-input">
                </div>
            </header>

            <div class="content">
                <h2>Conteúdo principal</h2>
                <p>Sistema de gestão GB Sistemas.</p>

                <div id="empresasGrid" class="empresas-grid-container">
                </div>
            </div>
        </main>
    </div>
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- Centraliza o modal -->
            <div class="modal-content">
                <div class="modal-header text-center w-100"> <!-- Centraliza o título -->
                    <h5 class="modal-title mx-auto" id="importModalLabel">Cadastrar empresas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body d-flex">
                    <div class="menu-lateral">
                        <button class="btn btn-light w-100 mb-1" onclick="mostrarConteudo('manual')">Importar
                            Manual</button>
                        <button class="btn btn-light w-100 mb-2" onclick="mostrarConteudo('prefeitura')">Importar
                            Prefeitura</button>
                        <button class="btn btn-light w-100" onclick="mostrarConteudo('arquivo')">Importar
                            Arquivo.txt</button>
                    </div>
                    <div class="conteudo-modal flex-grow-1 ps-3">
                        <div id="conteudo-manual" class="conteudo">
                            <input type="text" id="cadCnpj" class="form-control mb-1" placeholder="CNPJ">
                            <input type="text" id="cadEmp" class="form-control mb-2" placeholder="Nome empresa">
                            <button class="btn btn-primary" onclick="importEp()">Cadastrar</button>
                        </div>
                        <div id="conteudo-prefeitura" class="conteudo" style="display: none;">
                            <button class="btn btn-primary">Buscar Empresas Cadastradas na Representação</button>
                        </div>
                        <div id="conteudo-arquivo" class="conteudo" style="display: none;">
                            <div class="drop-area" id="dropArea">
                                <div class="drop-message">
                                    <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                    <p>Arraste um arquivo .txt e solte-o aqui</p>
                                    <p class="text-muted">ou</p>
                                    <label for="fileInput" class="btn btn-primary">
                                        Selecionar Arquivo
                                        <input type="file" id="fileInput" accept=".txt" style="display: none;">
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Adicionar este bloco de código antes do fechamento da tag </body> -->
    <div class="modal fade" id="buscarModal" tabindex="-1" aria-labelledby="buscarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="buscarModalLabel">Configurações de Busca</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <!-- Conteúdo do modal será adicionado posteriormente -->
                    <p>Configurações de busca em desenvolvimento.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary">Salvar Configurações</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function importEp() {
            const user = firebase.auth().currentUser;
            if (!user) {
                exibirAlerta('Faça login para cadastrar empresas', 'erro');
                return;
            }

            try {
                const cnpj = document.getElementById("cadCnpj").value.trim();
                const nome = document.getElementById("cadEmp").value.trim();

                if (!cnpj || !nome) {
                    throw new Error('Preencha todos os campos');
                }

                if (!validarCNPJ(cnpj)) {
                    throw new Error('CNPJ inválido');
                }

                const cnpjLimpo = cnpj.replace(/[^\d]/g, '');

                // Referência para a subcoleção de empresas do usuário
                const empresasDoUsuarioRef = db.collection('usuarios').doc(user.uid).collection('empresas');

                empresasDoUsuarioRef.doc(cnpjLimpo).set({
                    cnpj: cnpjLimpo,
                    cnpjFormatado: cnpj,
                    nome: nome,
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                    usuarioCadastro: user.uid
                })
                    .then(() => {
                        exibirAlerta('Empresa cadastrada com sucesso!', 'sucesso');
                        carregarEmpresas(); // Atualiza a lista de empresas no painel

                        // Limpa os campos do formulário
                        document.getElementById("cadCnpj").value = "";
                        document.getElementById("cadEmp").value = "";
                    })
                    .catch((error) => {
                        console.error('Erro ao cadastrar empresa:', error);
                        exibirAlerta(`Erro ao cadastrar: ${error.message}`, 'erro');
                    });
            } catch (error) {
                console.error('Erro de validação:', error);
                exibirAlerta(error.message, 'erro');
            }
        }
        // Função para exibir o alerta animado
        function exibirAlerta(mensagem, tipo = "sucesso") {
    const alerta = document.createElement("div");
    alerta.className = "meu-alerta";
    alerta.innerText = mensagem;

    document.body.appendChild(alerta);

    // Animação de entrada
    setTimeout(() => alerta.style.opacity = "1", 100);

    // Remover alerta após 3 segundos
    setTimeout(() => {
        alerta.style.opacity = "0";
        setTimeout(() => alerta.remove(), 500);
    }, 3000);
}


        document.addEventListener('DOMContentLoaded', function () {
            const btnBuscar = document.getElementById('btnBuscar');
            if (btnBuscar) {
                btnBuscar.addEventListener('click', function (e) {
                    e.preventDefault();
                    const buscarModal = new bootstrap.Modal(document.getElementById('buscarModal'));
                    buscarModal.show();
                });
            }
        });
        // Adicionar evento para quando o modal for fechado
        document.getElementById('importModal').addEventListener('hidden.bs.modal', function () {
            // Recarregar a página
            window.location.reload();
        });
        function continuarCadastro() {
            // Limpar os campos de CNPJ e nome da empresa
            document.getElementById('cadCnpj').value = '';
            document.getElementById('cadEmp').value = '';

            // Simplesmente fecha o modal
            const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            confirmModal.hide();

            // Opcional: Definir foco no campo de CNPJ
            document.getElementById('cadCnpj').focus();
        }

        function finalizarCadastro() {
            // Recarrega a página
            window.location.reload();
        }

        // Add event listener to handle modal close (X button)
        document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function () {
            finalizarCadastro();
        });
    </script>
    </script>
    <script>
        // Função para validar e formatar CNPJ
        function normalizarCNPJ(cnpj) {
            return cnpj.replace(/[^\d]/g, '');
        }
        // Improved carregarEmpresas function with error handling and persistence
        function carregarEmpresas() {
            const user = firebase.auth().currentUser;
            if (!user) {
                console.error('Usuário não autenticado');
                return;
            }

            const grid = document.getElementById('empresasGrid');
            grid.innerHTML = ''; // Limpar grid

            // Referência para a subcoleção de empresas do usuário atual
            const empresasDoUsuarioRef = db.collection('usuarios').doc(user.uid).collection('empresas');

            empresasDoUsuarioRef
                .get()
                .then((snapshot) => {
                    if (snapshot.empty) {
                        grid.innerHTML = '<p>Nenhuma empresa cadastrada</p>';
                        return;
                    }

                    const empresas = [];
                    snapshot.forEach((doc) => {
                        const empresa = doc.data();
                        empresas.push(empresa);
                    });

                    // Armazenar empresas no localStorage para persistência
                    localStorage.setItem('empresasCadastradas', JSON.stringify(empresas));

                    renderizarEmpresas(empresas);
                })
                .catch((error) => {
                    console.error("Erro ao carregar empresas:", error);
                    grid.innerHTML = `<p>Erro ao carregar empresas: ${error.message}</p>`;
                });
        }

        function renderizarEmpresas(empresas) {
            const grid = document.getElementById('empresasGrid');
            grid.innerHTML = ''; // Limpar grid antes de renderizar

            if (empresas.length === 0) {
                grid.innerHTML = '<p>Nenhuma empresa cadastrada</p>';
                return;
            }

            empresas.forEach((empresa) => {
                const div = document.createElement('div');
                div.className = 'empresa';
                div.innerHTML = `
            <p><strong>Nome:</strong> ${empresa.nome} <strong>CNPJ:</strong> ${empresa.cnpjFormatado || empresa.cnpj}</p>
            <button class="btn-executar" onclick="executarAutomacao('${empresa.cnpj}')">Executar</button>
        `;
                grid.appendChild(div);
            });
        }
        // Função para carregar empresas do localStorage quando a página for carregada
        function carregarEmpresasDoLocalStorage() {
            const empresasSalvas = localStorage.getItem('empresasCadastradas');
            if (empresasSalvas) {
                const empresas = JSON.parse(empresasSalvas);
                renderizarEmpresas(empresas);
            }
        }
        // Event Listeners para importação de arquivo
        document.getElementById('dropArea').addEventListener('drop', function (e) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/plain') {
                importarArquivoTXT(files[0]);
            }
        });

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const files = e.target.files;
            if (files.length > 0 && files[0].type === 'text/plain') {
                importarArquivoTXT(files[0]);
            }
        });

        // Carregar empresas quando a página carregar
        document.addEventListener('DOMContentLoaded', function () {
            carregarEmpresas();
        });

        function adicionarEmpresa(cnpj, nome) {
            // Verificar se há um usuário autenticado
            const user = firebase.auth().currentUser;
            if (!user) {
                console.error('Usuário não autenticado');
                alert('Faça login para cadastrar empresas');
                return Promise.reject(new Error('Usuário não autenticado'));
            }

            // Validar CNPJ
            if (!validarCNPJ(cnpj)) {
                console.error('CNPJ inválido:', cnpj);
                alert('CNPJ inválido. Por favor, verifique o número.');
                return Promise.reject(new Error('CNPJ inválido'));
            }

            // Limpar CNPJ
            const cnpjLimpo = normalizarCNPJ(cnpj);

            // Referência para a subcoleção de empresas do usuário
            const empresasDoUsuarioRef = db.collection('usuarios').doc(user.uid).collection('empresas');

            // Verificar se a empresa já existe para este usuário
            return empresasDoUsuarioRef.doc(cnpjLimpo).get()
                .then((docSnapshot) => {
                    if (docSnapshot.exists) {
                        console.log(`Empresa com CNPJ ${cnpjLimpo} já existe. Atualizando...`);
                    }

                    // Objeto de empresa padronizado
                    const empresa = {
                        cnpj: cnpjLimpo,
                        cnpjFormatado: cnpj,
                        nome: nome.trim(),
                        dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                        usuarioCadastro: user.uid
                    };

                    // Usar set com merge para evitar duplicatas
                    return empresasDoUsuarioRef.doc(cnpjLimpo).set(empresa, { merge: true });
                })
                .then(() => {
                    console.log(`Empresa ${nome} cadastrada/atualizada com sucesso!`);
                    carregarEmpresas(); // Recarregar apenas empresas do usuário atual
                })
                .catch((error) => {
                    console.error('Erro ao adicionar/atualizar empresa:', error);
                    alert(`Erro ao adicionar empresa: ${error.message}`);
                    throw error;
                });
        }
        function mostrarConteudo(tipo) {
            document.querySelectorAll('.conteudo').forEach(div => div.style.display = 'none');
            document.getElementById(`conteudo-${tipo}`).style.display = 'block';
        }

        function listarEmpresas() {
            db.collection('empresas')
                .get()
                .then((snapshot) => {
                    const empresas = [];
                    snapshot.forEach((doc) => {
                        empresas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    console.log('Empresas cadastradas:', empresas);
                    return empresas;
                })
                .catch((error) => {
                    console.error('Erro ao listar empresas:', error);
                });
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Criar coleção inicial (opcional)
            criarColecaoEmpresas();

            // Botão de cadastro manual
            document.getElementById('btnCadastrarEmpresa').addEventListener('click', () => {
                const cnpj = document.getElementById('inputCNPJ').value;
                const nome = document.getElementById('inputNomeEmpresa').value;
                adicionarEmpresa(cnpj, nome);
            });

            // Botão para listar empresas
            document.getElementById('btnListarEmpresas').addEventListener('click', listarEmpresas);
        });
    </script>

    <style>
        .menu-lateral {
            width: 200px;
            border-right: 1px solid #ddd;
            padding-right: 10px;
        }

        .conteudo {
            display: none;
        }

        .modal-header {
            justify-content: center;
        }
    </style>


    <script>
        // Add event listener for the Cadastrar button
        document.addEventListener('DOMContentLoaded', function () {
            const cadastrarBtn = document.getElementById('btnCadastrar');
            if (cadastrarBtn) {
                cadastrarBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const modal = new bootstrap.Modal(document.getElementById('importModal'));
                    modal.show();
                });
            }
        });
        const style = document.createElement('style');
        style.textContent = `
            .drop-area {
                border: 2px dashed #ccc;
                border-radius: 8px;
                padding: 40px 20px;
                text-align: center;
                background-color: #f8f9fa;
                transition: all 0.3s;
            }
            .drop-area.highlight {
                border-color: #0d6efd;
                background-color: #e9ecef;
            }
            .drop-message {
                color: #6c757d;
            }
            .empresas-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
          .empresa {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 8px 12px;
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    min-height: 40px; /* Ajuste conforme necessário */
    display: flex;
    align-items: center; /* Centraliza os itens verticalmente */
    justify-content: space-between; /* Distribui os elementos na linha */
    gap: 10px; /* Espaçamento entre os itens */
}
    .empresa p {
    margin: 0;
    white-space: nowrap; /* Evita que os textos quebrem para a linha de baixo */
}
            .empresa:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
.btn-executar {
    background-color: #1E314B;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}


        `;
        document.head.appendChild(style);

        function iniciarScrapingEmpresas() {
            const content = document.querySelector('.content');
            if (content) {
                content.innerHTML = `
                    <h2>Importando Empresas</h2>
                    <p>Iniciando importação de empresas. Este processo pode levar alguns minutos...</p>
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                `;
            }

            fetch('/api/scrape-companies')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Falha na requisição: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Resposta da API:', data);
                    if (content) {
                        content.innerHTML = `
                            <h2>Importação de Empresas Iniciada</h2>
                            <p>${data.message}</p>
                            <p>As empresas estão sendo importadas em segundo plano. Você pode consultar a lista de empresas clicando em "Buscar".</p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Erro ao iniciar importação:', error);
                    if (content) {
                        content.innerHTML = `
                            <h2>Erro na Importação</h2>
                            <p>Ocorreu um erro ao iniciar a importação de empresas.</p>
                            <p>Detalhes: ${error.message}</p>
                        `;
                    }
                });
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const categoryHeaders = document.querySelectorAll('.category-header');   // Adicionar evento de clique para os cabeçalhos de categoria

            categoryHeaders.forEach(header => {
                header.addEventListener('click', function () {
                    this.parentElement.classList.toggle('active');   // Toggle da classe 'active' no elemento pai (li.menu-category)
                    const arrow = this.querySelector('.arrow');
                    if (this.parentElement.classList.contains('active')) {
                        arrow.classList.remove('fa-chevron-down');
                        arrow.classList.add('fa-chevron-up');
                    } else {
                        arrow.classList.remove('fa-chevron-up');
                        arrow.classList.add('fa-chevron-down');
                    }
                });
            });


            //    if (categoryHeaders.length > 0) { // Abrir o primeiro menu por padrão
            //      categoryHeaders[0].click();
            // }


            const searchInput = document.getElementById('searchInput');   // Get the search input element


            if (searchInput) {  // Add focus event listener
                searchInput.addEventListener('focus', function () {
                    this.classList.add('focused');
                });


                searchInput.addEventListener('blur', function () {  // Add blur event listener
                    this.classList.remove('focused');
                });


                searchInput.style.cursor = 'text';  // Set cursor to text
            }


            const logoutButton = document.getElementById('btnLogout');// Adicionar evento de logout ao botão
            if (logoutButton) {
                logoutButton.addEventListener('click', function () {
                    if (typeof fazerLogout === 'function') {
                        fazerLogout();
                    } else {
                        console.error('Função de logout não encontrada');
                    }
                });
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            // Verificação de elementos antes de adicionar listeners
            const btnCadastrar = document.getElementById('btnCadastrar');
            const btnLogout = document.getElementById('btnLogout');
            const fileInput = document.getElementById('fileInput');
            const dropArea = document.getElementById('dropArea');

            if (btnCadastrar) {
                btnCadastrar.addEventListener('click', function (e) {
                    e.preventDefault();
                    const modal = new bootstrap.Modal(document.getElementById('importModal'));
                    modal.show();
                });
            }

            if (btnLogout) {
                btnLogout.addEventListener('click', function () {
                    fazerLogout(); // Certifique-se que esta função existe
                });
            }

            if (fileInput) {
                fileInput.addEventListener('change', function (e) {
                    const files = e.target.files;
                    if (files.length > 0 && files[0].type === 'text/plain') {
                        importarArquivoTXT(files[0]);
                    }
                });
            }

            if (dropArea) {
                dropArea.addEventListener('drop', function (e) {
                    e.preventDefault();
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'text/plain') {
                        importarArquivoTXT(files[0]);
                    }
                });
            }

            // Carregar empresas após verificações
            carregarEmpresas();
        });

        function fazerLogout() {
            firebase.auth().signOut().then(() => {
                // Redirecionar para página de login
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Erro ao fazer logout:', error);
            });
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const removeFile = document.getElementById('removeFile');
            const parseResults = document.getElementById('parseResults');
            const empresasCount = document.getElementById('empresasCount');
            const empresasTableBody = document.getElementById('empresasTableBody');
            const importBtn = document.getElementById('importBtn');
            let empresasEncontradas = [];
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('highlight');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('highlight');
                }, false);
            });
            dropArea.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
            removeFile.addEventListener('click', resetFileInput, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    handleFiles(files[0]);
                }
            }

            function handleFileSelect(e) {
                const files = e.target.files;

                if (files.length > 0) {
                    handleFiles(files[0]);
                }
            }

            function handleFiles(file) {
                if (file.type !== 'text/plain') {
                    alert('Por favor, selecione um arquivo .txt');
                    return;
                }

                fileName.textContent = file.name;
                fileInfo.style.display = 'block';

                const reader = new FileReader();
                reader.onload = function (e) {
                    const content = e.target.result;
                    parseFileContent(content);
                };
                reader.readAsText(file);
            }

            function parseFileContent(content) {// Função melhorada para analisar o conteúdo do arquivo
                const empresasEncontradas = [];
                const lines = content.split('\n').filter(line => line.trim() !== '');

                lines.forEach(line => {
                    const cnpjRegex = /(\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2})/;
                    const cnpjMatch = line.match(cnpjRegex);
                    if (cnpjMatch) {
                        const cnpj = cnpjMatch[1].replace(/[^\d]/g, '');  // Clean CNPJ
                        let nome = line.replace(cnpjMatch[0], '').trim();
                        if (nome) {
                            empresasEncontradas.push({
                                cnpj: cnpj,
                                nome: nome
                            });
                        }
                    }
                });

                return empresasEncontradas;
            }

            function importEmpresas() {
                const batch = db.batch();

                // Exemplo em importarArquivoTXT
                const empresaRef = db.collection('empresas').doc(cnpjLimpo);
                batch.set(empresaRef, {
                    cnpj: cnpjLimpo,
                    cnpjFormatado: cnpj,
                    nome: nome,
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });  // Usando merge: true para evitar duplicatas

                batch.commit()
                    .then(() => {
                        alert(`Importação concluída! ${empresasEncontradas.length} empresas importadas.`);
                        carregarEmpresas();
                    })
                    .catch((error) => {
                        console.error('Erro ao importar empresas:', error);
                    });
            }
            function insertEmpresasIntoDatabase(empresas) {// Esta função seria chamada após importar as empresas e confirmação do usuário
                fetch('/api/save-empresas', { // Código para interagir com o SQLite através de sua API
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ empresas: empresas })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Empresas salvas no banco de dados:', data);
                        alert(`${data.saved} empresas foram salvas com sucesso!`);  // Atualizar a interface ou mostrar mensagem de sucesso
                        if (typeof carregarEmpresas === 'function') {
                            carregarEmpresas();
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao salvar empresas:', error);
                        alert('Ocorreu um erro ao salvar as empresas no banco de dados.');
                    });
            }

            function displayParseResults(empresas) {
                empresasTableBody.innerHTML = '';
                empresasCount.textContent = empresas.length;

                empresas.forEach(empresa => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${empresa.cnpj}</td>
                        <td>${empresa.nome}</td>
                    `;
                    empresasTableBody.appendChild(row);
                });

                parseResults.style.display = 'block';
            }

            function resetFileInput() {
                fileInput.value = '';
                fileInfo.style.display = 'none';
                parseResults.style.display = 'none';
                importBtn.disabled = true;
            }

            importBtn.addEventListener('click', importEmpresas);

            function importEmpresas() {
                if (empresasEncontradas.length === 0) {
                    alert('Nenhuma empresa para importar.');
                    return;
                }

                const batch = db.batch();
                empresasEncontradas.forEach(empresa => {
                    const empresaRef = db.collection('empresas').doc(empresa.cnpj);
                    batch.set(empresaRef, {
                        cnpj: empresa.cnpj,
                        nome: empresa.nome,
                        dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                });

                batch.commit()
                    .then(() => {
                        alert(`Importação concluída! ${empresasEncontradas.length} empresas importadas.`);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                        modal.hide();
                        carregarEmpresas();
                    })
                    .catch((error) => {
                        console.error('Erro ao importar empresas:', error);
                        alert('Erro ao importar empresas. Verifique o console para detalhes.');
                    });
            }
        });
    </script>
    <script src="auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="dashboard.js"></script>
    <script>
      function executarAutomacao(empresaId) {
    const apiUrl = '/api/execute-automation';
    console.log('Tentando iniciar automação para empresa:', empresaId);
    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ empresaId: empresaId })
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Falha na requisição: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Resposta da automação:', data);
            // Exibe o alerta de sucesso com o mesmo estilo da notificação de cadastro
            exibirAlerta('Automação iniciada com sucesso!', 'sucesso');
        })
        .catch(error => {
            console.error('Erro ao iniciar automação:', error);
            // Exibe o alerta de erro com o mesmo estilo da notificação de cadastro
            exibirAlerta('Erro ao iniciar automação. Verifique o console para detalhes.', 'erro');
        });
}

// Função para exibir o alerta animado, similar ao de cadastro
function exibirAlerta(mensagem, tipo = "sucesso") {
    const alerta = document.createElement("div");
    alerta.className = "meu-alerta";
    alerta.innerText = mensagem;
    alerta.style.position = "fixed";
    alerta.style.top = "10px";
    alerta.style.right = "10px";
    alerta.style.zIndex = "1000";
    alerta.style.opacity = "0";
    alerta.style.transition = "opacity 0.5s ease-in-out";

    // Definir cor do alerta com base no tipo
    if (tipo === 'sucesso') {
        alerta.style.backgroundColor = "#28a745"; // Verde para sucesso
        alerta.style.color = "#fff";
    } else if (tipo === 'erro') {
        alerta.style.backgroundColor = "#dc3545"; // Vermelho para erro
        alerta.style.color = "#fff";
    }

    document.body.appendChild(alerta);

    // Animação de entrada
    setTimeout(() => alerta.style.opacity = "1", 100);

    // Remover alerta após 3 segundos
    setTimeout(() => {
        alerta.style.opacity = "0";
        setTimeout(() => alerta.remove(), 500);
    }, 3000);
}

        document.addEventListener('DOMContentLoaded', function () {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('Status do servidor:', data);
                })
                .catch(error => {
                    console.error('Servidor de API não está respondendo:', error);
                });
            if (firebase && firebase.auth) {
                firebase.auth().onAuthStateChanged(function (user) {
                    if (!user) {
                        window.location.href = 'index.html';
                    } else {
                        console.log('Usuário autenticado, iniciando automação...');
                        const empresaId = '03.300.663/0001-10';
                        setTimeout(() => {
                            executarAutomacao(empresaId);
                        }, 1000);
                    }
                });
            } else {
                console.error('Firebase Auth não está disponível');
            }
        });
        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]/g, '');
            if (cnpj.length !== 14) return false;
            let soma = 0;
            let peso = 2;
            for (let i = 11; i >= 0; i--) {
                soma += parseInt(cnpj.charAt(i)) * peso;
                peso = peso === 9 ? 2 : peso + 1;
            }
            let resto = soma % 11;
            let digitoVerificador1 = resto < 2 ? 0 : 11 - resto;
            soma = 0;
            peso = 2;
            for (let i = 12; i >= 0; i--) {
                soma += parseInt(cnpj.charAt(i)) * peso;
                peso = peso === 9 ? 2 : peso + 1;
            }

            resto = soma % 11;
            let digitoVerificador2 = resto < 2 ? 0 : 11 - resto;
            return parseInt(cnpj.charAt(12)) === digitoVerificador1 &&
                parseInt(cnpj.charAt(13)) === digitoVerificador2;
        }

        // Função para continuar cadastrando empresas
        function continuarCadastro() {
            // Apenas fecha o modal para continuar
            const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            confirmModal.hide();
        }

        // Função para finalizar cadastro
        function finalizarCadastro() {
            // Fecha o modal e pode redirecionar para outra página se necessário
            const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            confirmModal.hide();
        }


        // Adicionar event listeners para carregar empresas
        document.addEventListener('DOMContentLoaded', function () {
            // Carregar empresas do localStorage imediatamente
            carregarEmpresasDoLocalStorage();

            // Carregar empresas do Firestore após autenticação
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    carregarEmpresas();
                }
            });
        });

        function importarArquivoTXT(file) {
            const user = firebase.auth().currentUser;
            if (!user) {
                alert('Faça login para importar empresas');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                const linhas = content.split('\n');
                const batch = db.batch();
                const empresasUnicas = new Set();

                // Referência para a subcoleção de empresas do usuário
                const empresasDoUsuarioRef = db.collection('usuarios').doc(user.uid).collection('empresas');

                linhas.forEach(linha => {
                    const [cnpj, nome] = linha.split(';').map(item => item.trim());

                    if (cnpj && nome && validarCNPJ(cnpj)) {
                        const cnpjLimpo = normalizarCNPJ(cnpj);

                        if (!empresasUnicas.has(cnpjLimpo)) {
                            empresasUnicas.add(cnpjLimpo);
                            const empresaRef = empresasDoUsuarioRef.doc(cnpjLimpo);

                            batch.set(empresaRef, {
                                cnpj: cnpjLimpo,
                                cnpjFormatado: cnpj,
                                nome: nome,
                                dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                                usuarioCadastro: user.uid
                            }, { merge: true });
                        }
                    }
                });

                batch.commit()
                    .then(() => {
                        alert(`Importação concluída! ${empresasUnicas.size} empresas importadas/atualizadas.`);
                        carregarEmpresas();

                        const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                        if (modal) modal.hide();
                    })
                    .catch(error => {
                        console.error('Erro na importação:', error);
                        alert('Erro na importação. Verifique o console.');
                    });
            };
            reader.readAsText(file, 'UTF-8');
        }
        document.getElementById('dropArea').addEventListener('drop', function (e) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/plain') {
                importarArquivoTXT(files[0]);
            }
        });

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const files = e.target.files;

            if (files.length > 0 && files[0].type === 'text/plain') {
                importarArquivoTXT(files[0]);
            }
        });

        /*   function criarColecaoEmpresas() {
               const primeiraEmpresa = {
                   cnpj: '00000000000000', // CNPJ de exemplo
                   nome: 'Empresa Modelo',
                   dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                   status: 'Empresa Inicial de Teste'
               };
               db.collection('empresas').add(primeiraEmpresa)
                   .then((docRef) => {
                       console.log('Coleção de empresas criada com sucesso!');
                       console.log('Documento inicial criado com ID: ', docRef.id);
                   })
                   .catch((error) => {
                       console.error('Erro ao criar coleção:', error);
                   });
           }*/
    </script>
</body>

</html>